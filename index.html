<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unwrap USDT0 to gUSDT - Stable Testnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚úÖ UMD build so window.ethers exists -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 40px auto; padding: 0 16px; }
    button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; }
    button.primary { background: #2563eb; color: white; width: 100%; margin-top: 12px; }
    input { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; }
    #status { background: #f5f5f5; padding: 10px; margin-top: 12px; border-radius: 6px; white-space: pre-line; font-size: 13px; }
  </style>
</head>
<body>
  <h2>Unwrap USDT0 ‚Üí gUSDT (Stable Testnet)</h2>

  <button id="connectBtn" class="primary">Connect Wallet</button>
  <div id="walletAddress"></div>

  <button id="unwrapBtn" class="primary" disabled>Unwrap ke gUSDT</button>

  <div id="status"></div>

  <script>
    // ‚úÖ Contract addresses
    const USDT0_ADDRESS   = "0x78Cf24370174180738C5B8E352B6D14c83a6c9A9";
    const WRAPPER_ADDRESS = "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90";

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)"
    ];

    const WRAPPER_ABI = [
      "function depositTo(address recipient) payable returns (uint256)"
    ];

    let provider, signer, userAddress;

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const unwrapBtn = document.getElementById("unwrapBtn");
    const walletEl = document.getElementById("walletAddress");

    function log(msg) {
      statusEl.textContent += msg + "\n";
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert("Install MetaMask dulu mas ‚úÖ");
        return;
      }

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });

        provider = new window.ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        walletEl.textContent = "‚úÖ Connected: " + userAddress;
        unwrapBtn.disabled = false;

        const net = await provider.getNetwork();
        log("üì° Chain ID: " + net.chainId.toString());
        log("‚úÖ Wallet berhasil connect!");
      } catch (err) {
        log("‚ùå Wallet gagal connect: " + err.message);
      }
    }

    async function unwrap() {
      unwrapBtn.disabled = true;
      log("üöÄ Mulai proses unwrap...");

      try {
        const usdt0 = new window.ethers.Contract(USDT0_ADDRESS, ERC20_ABI, signer);
        const wrapper = new window.ethers.Contract(WRAPPER_ADDRESS, WRAPPER_ABI, signer);

        // ‚úÖ Check allowance
        log("üîé Cek allowance...");
        const allowance = await usdt0.allowance(userAddress, WRAPPER_ADDRESS);

        if (allowance.eq(0)) {
          log("‚úÖ Kirim approve...");
          const tx = await usdt0.approve(WRAPPER_ADDRESS, window.ethers.constants.MaxUint256);
          log("‚è≥ Approve tx: " + tx.hash);
          await tx.wait();
          log("‚úÖ Approve confirmed!");
        } else {
          log("‚úÖ Allowance sudah cukup ‚Äî skip approve");
        }

        // ‚úÖ Correct depositTo call without amount, WITH value
        log("üî• Call depositTo...");

        const depTx = await wrapper.depositTo(userAddress, {
          value: window.ethers.utils.parseUnits("0.01", 18) // ‚úÖ FIX UTAMA
        });

        log("‚è≥ depositTo tx: " + depTx.hash);
        await depTx.wait();

        log("üéâ SUCCESS! gUSDT sudah masuk ke wallet ‚úÖ");

      } catch (err) {
        log("‚ùå ERROR:");
        log(err.message || err.toString());
      }

      unwrapBtn.disabled = false;
    }

    connectBtn.onclick = connectWallet;
    unwrapBtn.onclick = unwrap;
  </script>
</body>
</html>
