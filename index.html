<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unwrap USDT0 to gUSDT - Stable Testnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 40px auto; padding: 0 16px; }
    button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; }
    button.primary { background: #2563eb; color: white; width: 100%; margin-top: 12px; }
    input { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; }
    #status { background: #f5f5f5; padding: 10px; margin-top: 12px; border-radius: 6px; white-space: pre-line; font-size: 13px; }
  </style>
</head>
<body>
  <h2>Unwrap USDT0 ‚Üí gUSDT (Stable Testnet)</h2>

  <p>Pastikan MetaMask kamu sudah di <b>Stable Testnet</b>.</p>

  <button id="connectBtn" class="primary">Connect Wallet</button>
  <div id="walletAddress"></div>

  <input id="amount" type="text" placeholder="Jumlah USDT0 (contoh: 10)" />
  <button id="unwrapBtn" class="primary" disabled>Unwrap ke gUSDT</button>

  <div id="status"></div>

  <script>
    // ‚úÖ ADDRESS FINAL DARI KAMU
    const USDT0_ADDRESS   = "0x78Cf24370174180738C5B8E352B6D14c83a6c9A9";
    const WRAPPER_ADDRESS = "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90";
    const USDT0_DECIMALS  = 6;

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)",
      "function balanceOf(address account) external view returns (uint256)"
    ];

    const WRAPPER_ABI = [
      "function depositTo(address account, uint256 amount) external"
    ];

    let provider, signer, userAddress;

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const unwrapBtn = document.getElementById("unwrapBtn");
    const walletEl = document.getElementById("walletAddress");
    const amountInput = document.getElementById("amount");

    function log(msg) {
      statusEl.textContent += msg + "\n";
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    // ‚úÖ FIXED CONNECT WALLET
    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask belum terpasang mas ‚úÖ");
        return;
      }

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        walletEl.textContent = "‚úÖ Connected: " + userAddress;
        unwrapBtn.disabled = false;

        const net = await provider.getNetwork();
        log("üì° Chain ID: " + net.chainId.toString());
        log("‚úÖ Wallet connected!");
      } catch (err) {
        log("‚ùå Gagal connect: " + err.message);
      }
    }

    async function unwrap() {
      const rawAmount = amountInput.value.trim();
      if (!rawAmount) return alert("Isi jumlah dulu mas ‚úÖ");

      unwrapBtn.disabled = true;
      log("üöÄ Mulai proses unwrap...");

      try {
        const usdt0 = new ethers.Contract(USDT0_ADDRESS, ERC20_ABI, signer);
        const wrapper = new ethers.Contract(WRAPPER_ADDRESS, WRAPPER_ABI, signer);

        const amount = ethers.utils.parseUnits(rawAmount, USDT0_DECIMALS);

        const bal = await usdt0.balanceOf(userAddress);
        if (bal.lt(amount)) {
          log("‚ùå Saldo USDT0 kurang. Balance: " +
              ethers.utils.formatUnits(bal, USDT0_DECIMALS));
          unwrapBtn.disabled = false;
          return;
        }

        log("üîé Cek allowance...");
        const allowance = await usdt0.allowance(userAddress, WRAPPER_ADDRESS);

        if (allowance.lt(amount)) {
          log("‚úÖ Kirim approve...");
          const tx = await usdt0.approve(WRAPPER_ADDRESS, amount);
          log("‚è≥ Approve tx: " + tx.hash);
          await tx.wait();
          log("‚úÖ Approve confirmed!");
        } else {
          log("‚úÖ Allowance cukup, skip approve");
        }

        log("üî• Call depositTo...");
        const depTx = await wrapper.depositTo(userAddress, amount);
        log("‚è≥ depositTo tx: " + depTx.hash);
        await depTx.wait();

        log("üéâ Berhasil! gUSDT sudah masuk ke wallet ‚úÖ");
      } catch (err) {
        log("‚ùå Error: " + (err.reason || err.message || err));
      }

      unwrapBtn.disabled = false;
    }

    connectBtn.onclick = connectWallet;
    unwrapBtn.onclick = unwrap;
  </script>
</body>
</html>
