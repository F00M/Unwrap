<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THDX ‚Ä¢ USDT0 ‚Üí gUSDT (Approve + Redeem)</title>

<!-- Load ethers -->
<script>
(function(){
  const s=document.createElement("script");
  s.src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";
  s.onload=()=>console.log("‚úÖ ethers loaded");
  s.onerror=()=>alert("‚ö†Ô∏è Gagal memuat ethers.js. Coba reload.");
  document.head.appendChild(s);
})();
</script>

<style>
  :root{--bg:#0b1220;--card:#121a2a;--muted:#22304a;--field:#0f1625;--acc:#7c5cff;}
  body{margin:0;background:var(--bg);color:#e6edf3;font-family:system-ui,Arial;min-height:100vh;display:grid;place-items:center}
  .card{width:min(520px,92vw);background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.45)}
  h1{margin:0 0 12px;text-align:center;color:var(--acc)}
  input{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid var(--muted);background:var(--field);color:#fff;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  button{width:100%;padding:12px;border:0;border-radius:10px;margin-top:10px;font-weight:700;font-size:15px;cursor:pointer}
  .primary{background:linear-gradient(90deg,#6ee7ff,#7c5cff);color:#04131a}
  .ok{background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff}
  .muted{background:#24324d;color:#9fb0d9}
  pre{background:var(--field);border:1px solid var(--muted);border-radius:10px;padding:10px;margin-top:12px;white-space:pre-wrap;max-height:260px;overflow:auto;font-size:12.5px}
  small{color:#9fb0d9}
  label{display:block;font-size:12px;color:#9fb0d9;margin-top:10px}
</style>
</head>
<body>
  <div class="card">
    <h1>üåâ THDX ‚Ä¢ USDT0 ‚Üí gUSDT</h1>

    <div class="row">
      <button id="connect" class="primary">üîå Connect Wallet</button>
      <button id="switch"  class="muted">üîÅ Switch to Stable (2201)</button>
    </div>

    <label>USDT0 Token (Stable Testnet)</label>
    <input id="usdt0" placeholder="0x... alamat USDT0 (testnet)" value="">

    <label>Deposit Contract (unwrap gUSDT)</label>
    <input id="deposit" placeholder="0x... deposit contract" value="0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90">

    <div class="row">
      <input id="dec" placeholder="Token Decimals" value="6">
      <input id="amount" placeholder="Jumlah (contoh: 10)">
    </div>

    <input id="to" placeholder="Penerima gUSDT (default: wallet kamu)">

    <div class="row">
      <button id="approve" class="muted">üßæ Approve USDT0</button>
      <button id="redeem"  class="ok">üöÄ Redeem (depositTo)</button>
    </div>

    <pre id="log">log siap...</pre>
    <small>Tips: 10 USDT0 = 10 √ó 10^6 = 10,000,000 (decimals 6). Skrip ini otomatis hitung amountLD dari jumlah manusia.</small>
  </div>

<script>
(async function(){
  function log(m){const el=document.getElementById('log');el.textContent+=(el.textContent?'\n':'')+m;el.scrollTop=el.scrollHeight;console.log(m);}
  function $(id){return document.getElementById(id);}
  async function waitEthers(){while(typeof window.ethers==='undefined'){await new Promise(r=>setTimeout(r,120));}}

  await waitEthers();

  let provider, signer, me, chainId;

  const ERC20_ABI = [
    "function approve(address spender,uint256 value) external returns (bool)",
    "function decimals() view returns (uint8)",
    "function allowance(address owner,address spender) view returns (uint256)"
  ];

  async function connect(){
    try{
      if(!window.ethereum) throw new Error("Buka di browser wallet (MetaMask/OKX/Trust).");
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts",[]);
      signer   = provider.getSigner();
      me       = await signer.getAddress();
      const n  = await provider.getNetwork();
      chainId  = Number(n.chainId);
      $('connect').textContent = '‚úÖ Connected';
      if(!$('to').value) $('to').value = me;
      log(`‚úÖ Connected: ${me}\nChain: ${chainId}`);
    }catch(e){ log("‚ùå Connect error: "+(e.message||e)); }
  }

  async function switchStable(){
    const STABLE_ID = 2201;
    try{
      await window.ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:ethers.utils.hexValue(STABLE_ID)}]});
    }catch(err){
      if(err.code===4902 || (err.message||'').includes('Unrecognized')){
        await window.ethereum.request({
          method:'wallet_addEthereumChain',
          params:[{
            chainId: ethers.utils.hexValue(STABLE_ID),
            chainName: 'Stable Testnet',
            rpcUrls: ['https://rpc.testnet.stable.xyz'],
            blockExplorerUrls: ['https://blockscout.testnet.stable.xyz'],
            nativeCurrency: { name:'STBL', symbol:'STBL', decimals:18 }
          }]
        });
      }else{ throw err; }
    }
    const n=await provider.getNetwork(); chainId=Number(n.chainId);
    log(`üîÅ Switched: ${chainId}`);
  }

  function parseAmountLD(human, decimals){
    // terima "10" atau "10.5" ‚Üí ke smallest unit string
    return ethers.utils.parseUnits(String(human), Number(decimals));
  }

  async function ensureDecimals(tokenAddr){
    try{
      const t = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
      const d = await t.decimals();
      return Number(d);
    }catch{ return Number($('dec').value || 6); }
  }

  async function doApprove(){
    try{
      const token = $('usdt0').value.trim();
      const dep   = $('deposit').value.trim();
      const amt   = $('amount').value.trim();
      if(!token || !dep || !amt) return log("‚ö†Ô∏è Isi Token, Deposit, dan Amount.");

      const dec = await ensureDecimals(token);
      const amountLD = parseAmountLD(amt, dec);

      const erc20 = new ethers.Contract(token, ERC20_ABI, signer);
      log(`üßæ Approving ${amt} (dec=${dec}) to ${dep} ...`);
      const tx = await erc20.approve(dep, amountLD);
      log(`‚è≥ Approve TX: ${tx.hash}`);
      const rc = await tx.wait();
      log(`‚úÖ Approve success! Block ${rc.blockNumber}`);
    }catch(e){ log("‚ùå Approve error: "+(e.message||e)); }
  }

  // Coba depositTo dalam 2 varian ABI:
  // A) depositTo(address to, uint256 amount)
  // B) depositTo(address token, address to, uint256 amount)
  async function doRedeem(){
    try{
      const token = $('usdt0').value.trim();
      const dep   = $('deposit').value.trim();
      const to    = $('to').value.trim() || me;
      const amt   = $('amount').value.trim();
      if(!dep || !to || !amt) return log("‚ö†Ô∏è Isi Deposit, To, dan Amount.");
      const dec = await ensureDecimals(token || "0x0000000000000000000000000000000000000000");
      const amountLD = parseAmountLD(amt, dec);

      log(`üöÄ Redeem: mencoba depositTo(to,amount)...`);
      let abiA = ["function depositTo(address to,uint256 amount) external"];
      let cA   = new ethers.Contract(dep, abiA, signer);

      try{
        const txA = await cA.depositTo(to, amountLD);
        log(`‚è≥ depositTo(to,amount) TX: ${txA.hash}`);
        const rcA = await txA.wait();
        log(`‚úÖ Redeem success (A)! Block ${rcA.blockNumber}`);
        return;
      }catch(errA){
        log(`‚ÑπÔ∏è Varian A gagal: ${errA.message||errA}`);
        if(!token) return log("‚ö†Ô∏è Masukkan USDT0 token address untuk uji varian B.");

        log(`üîÅ Mencoba depositTo(token,to,amount)...`);
        const abiB = ["function depositTo(address token,address to,uint256 amount) external"];
        const cB   = new ethers.Contract(dep, abiB, signer);
        const txB  = await cB.depositTo(token, to, amountLD);
        log(`‚è≥ depositTo(token,to,amount) TX: ${txB.hash}`);
        const rcB  = await txB.wait();
        log(`‚úÖ Redeem success (B)! Block ${rcB.blockNumber}`);
      }
    }catch(e){ log("‚ùå Redeem error: "+(e.message||e)); }
  }

  $('connect').onclick = connect;
  $('switch').onclick  = switchStable;
  $('approve').onclick = doApprove;
  $('redeem').onclick  = doRedeem;

  // Auto-fill penerima saat load jika sudah ada wallet (opsional, aman diabaikan)
  if(window.ethereum){
    window.ethereum.on?.('chainChanged', ()=>location.reload());
    window.ethereum.on?.('accountsChanged', ()=>location.reload());
  }
})();
</script>
</body>
</html>
